\documentclass{scrartcl}
\usepackage{multicol}
\usepackage{epigraph}
\usepackage{url}
\usepackage{listings}
\usepackage{graphicx}
\usepackage{color}
\usepackage[parfill]{parskip}
\usepackage{titlesec}
\usepackage{geometry}
\usepackage{todonotes}
\usepackage{hyperref}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{array}

\lstset{
breaklines=true,
breakautoindent=true,
postbreak=\space,
tabsize=2,
basicstyle=\ttfamily\footnotesize,
showspaces=false,
showstringspaces=false,
extendedchars=true,
}

\newcommand{\horizontalrule}[1]{\rule{\linewidth}{#1}}
\def\changemargin#1#2{\list{}{\rightmargin#2\leftmargin#1}\item[]}
\let\endchangemargin=\endlist

\newcounter{savepage}

\setlength{\LTleft}{0pt}

\title{\horizontalrule{1pt}\\[0.5cm]Large-scale drive-by download detection: visit$^n$. process. analyse. report.}
\subtitle{Master in System and Network Engineering \\[0.5cm] \horizontalrule{1pt} }
\author{}
\date{}

\begin{document}
\pagenumbering{gobble}
\newgeometry{top=4cm,bottom=1cm}

\centerline{\includegraphics[width=10cm]{Images/UvA-logo-english}}

\begin{center}
\horizontalrule{1pt}\\[0.5cm]
\usekomafont{title}{\huge Large-scale drive-by download detection: \\[0.2cm] visit$^n$. process. analyse. report.}
\\[0.1cm]
\usekomafont{subtitle}{Master in System and Network Engineering} \\[0.5cm]
\horizontalrule{1pt} 
\end{center}

\vspace{7cm}

\begin{center}

\Large
Students:\\[0.5cm]

\begin{minipage}{0.4\textwidth}
\begin{flushleft} \Large
Adriaan Dens\\\texttt{adriaan.dens@os3.nl}
\end{flushleft}
\end{minipage}%
\begin{minipage}{0.4\textwidth}
\begin{flushright} \Large
Martijn Bogaard\\\texttt{martijn.bogaard@os3.nl}
\end{flushright}
\end{minipage}\\[1.6cm]

\Large
Supervisors:\\[0.5cm]

\begin{minipage}{0.4\textwidth}
\begin{flushleft} \Large
Jop van der Lelie\\\texttt{jop.vanderlelie@ncsc.nl}
\end{flushleft}
\end{minipage}%
\begin{minipage}{0.4\textwidth}
\begin{flushright} \Large
Wouter Katz\\\texttt{wouter.katz@ncsc.nl}
\end{flushright}
\end{minipage}\\[1.6cm]

{\Large \today}
\end{center}

\clearpage
\restoregeometry

\section*{Abstract}

Current malware analysis systems do not allow for concurrently visiting multiple websites. In this paper we present an algorithm which solves this problem by extensive monitoring of the environment. Additionally, a proof of concept has been developed which implements this algorithm. Results show a significant performance gain compared to current systems.

\clearpage

\tableofcontents

\clearpage

\pagenumbering{arabic}

\section{Introduction}
\input{Chapters/01_Introduction.tex}

\clearpage

\section{Theory}
\input{Chapters/02_Background.tex}

\clearpage

\newgeometry{bottom=0.1cm}
\section{Approach and Methods}
\input{Chapters/03_Methodology.tex}

\clearpage

\section{Results}
\input{Chapters/04_Results.tex}

\clearpage

\section{Conclusion}
\input{Chapters/99_Conclusion.tex}

\clearpage

\section{Future work}
\input{Chapters/99_Future_Work.tex}

\clearpage

\section*{Acknowledgements}
\addcontentsline{toc}{section}{Acknowledgements}

First and foremost, we would like to thank our supervisors, Jop van der Lelie and Wouter Katz from the Dutch National Cyber Security Center, for the support and insight they have given during our research project. They have gravely improved the quality of this report.

We would also like to thank the Cuckoo developers (especially Jurriaan Bremer) who helped us demystify the inner workings of Cuckoo and even helped us resolving the bugs we introduced ourselves during this project.

\clearpage

\todo{Cites consistent maken}

\addcontentsline{toc}{section}{References}
\bibliographystyle{abbrv}
\bibliography{report}

\clearpage

\section*{Appendix A: Simple Analyser}
\addcontentsline{toc}{section}{Appendix A: Simple Analyser}

To implement step 3 of the algorithm a very simple analyser was written which detects a process spawn beneath tab processes. Although the real code\footnote{\url{https://github.com/MartijnB/cuckoo/blob/multi-url/utils/mass-analyse.py}} is a bit unclear, it is the same as the pseudo code in listing \ref{analysercode}.

\begin{lstlisting}[caption={Pseudo code for phase 3 of the algorithm},label={analysercode}]
function deep_process_spawn_analyser(graph)
    foreach vertex in graph
        if vertex.type == "process_spawned"
            if check_depth_in_graph(vertex, 0) > 1
                print "Malicious activity"
            endif
        endif
    endforeach
endfunction

function check_depth_in_graph(vertex, current_depth)
    parents = get_parents_of_vertex(vertex)
    # Actually we need only one parent
    if length_array(parents) > 0
        return check_depth_in_graph(parents[0], current_depth++)
    else
        # No more parents, we're at the root node
        return current_depth
    endif
endfunction
\end{lstlisting}

\clearpage

\section*{Appendix B: Raw benchmark data}
\addcontentsline{toc}{section}{Appendix B: Raw benchmark data}

\todo{Omschrijving toevoegen}

\begin{table}[h]
\begin{tabular}{@{}llllllll@{}}
\toprule
Anubis  & Cuckoo  & 1 URL       & 5 URLs      & 10 URLs      & 25 URLs      & 50 URLs      & 100 URLs     \\ \midrule
260,0s  & 148,5s  & 44,8s       & 93,7s       & 109,3s       & 144,2s       & 271,0s       & 455,9s        \\
311,0s  & 161,2s  & 45,2s       & 85,3s       & 100,4s       & 140,5s       & 240,3s       & 431,9s        \\
267,0s  & 152,2s  & 45,2s       & 67,7s       & 84,0s        & 152,2s       & 251,8s       & 438,8s        \\
299,0s  & 152,1s  & 47,1s       & 59,9s       & 86,9s        & 146,0s       & 272,2s       & 456,9s        \\
283,0s  & 143,4s  & 44,9s       & 67,6s       & 141,0s       & 156,4s       & 254,7s       & 482,3s        \\
271,0s  & 149,5s  & 43,8s       & 83,5s       & 100,8s       & 155,7s       & 252,3s       & 414,2s        \\
270,0s  & 152,9s  & 46,2s       & 74,8s       & 90,0s        & 138,4s       & 247,9s       & 480,1s        \\
250,0s  & 146,0s  & 44,7s       & 65,1s       & 135,1s       & 153,5s       & 240,7s       & 430,7s        \\
282,0s  & 159,0s  & 47,8s       & 92,5s       & 87,2s        & 161,5s       & 257,5s       & 410,6s        \\
265,0s  & 148,3s  & 60,0s       & 63,9s       & 93,5s        & 172,8s       & 297,0s       & 429,2s        \\
251,0s  & 153,5s  & 47,0s       & 76,4s       & 103,4s       & 185,4s       & 248,3s       & 452,5s        \\
264,0s  & 147,9s  & 47,6s       & 106,5s      & 90,0s        & 144,1s       & 265,3s       & 442,3s        \\
264,0s  & 160,7s  & 52,5s       & 74,4s       & 128,0s       & 156,0s       & 582,7s       & 537,1s        \\
279,0s  & 152,3s  & 51,3s       & 64,8s       & 95,7s        & 156,8s       & 265,4s       & 461,4s        \\
255,0s  & 144,0s  & 61,7s       & 65,9s       & 84,2s        & 160,3s       & 251,6s       & 441,2s        \\
357,0s  & 146,8s  & 45,8s       & 104,3s      & 109,1s       & 163,9s       & 261,5s       & 436,1s        \\
251,0s  & 164,3s  & 46,2s       & 69,7s       & 86,4s        & 166,9s       & 253,3s       & 438,3s        \\
279,0s  & 148,6s  & 46,9s       & 68,1s       & 103,5s       & 145,9s       & 332,1s       & 465,9s        \\
275,0s  & 152,5s  & 48,3s       & 69,6s       & 88,0s        & 185,9s       & 535,8s       & 409,4s        \\
265,0s  & 146,2s  & 61,2s       & 65,5s       & 93,3s        & 175,4s       & 258,9s       & 463,5s        \\
298,0s  & 148,1s  & 54,1s       & 70,6s       & 138,8s       & 202,8s       & 259,4s       & 466,5s        \\
256,0s  & 185,5s  & 45,7s       & 67,0s       & 104,7s       & 186,5s       & 284,9s       & 481,0s        \\
256,0s  & 161,1s  & 42,7s       & 74,4s       & 110,8s       & 165,1s       & 260,2s       & 451,8s        \\
271,0s  & 144,1s  & 54,1s       & 70,4s       & 95,8s        & 139,7s       & 267,6s       & 446,4s        \\
277,0s  & 151,9s  & 45,9s       & 69,5s       & 99,8s        & 146,3s       & 247,6s       & 448,0s        \\ \bottomrule
\end{tabular}
\caption{Raw values of benchmarks in seconds.}
\label{my-label}
\end{table}

\clearpage

\section*{Appendix C: Cuckoomon modifications}
\addcontentsline{toc}{section}{Appendix C: Cuckoomon modifications}
\label{cuckoomonmods}

Cuckoomon is the analyser component of Cuckoo. It hooks interesting API functions and logs their usage. As part of the development of the proof of concept, many hooks have been disabled and several missing ones added.

\textbf{Added hooks}

\begin{longtable}{*{2}{>{\arraybackslash}p{6cm}}}
URLDownloadToFileA     & HttpSendRequestExW           \\
FtpOpenFileA           & HttpEndRequestA              \\
FtpOpenFileW           & HttpEndRequestW              \\
FtpGetFileA            & HttpQueryInfoA               \\
FtpGetFileW            & HttpQueryInfoW               \\
FtpPutFileA            & InternetConfirmZoneCrossingA \\
FtpPutFileW            & InternetConfirmZoneCrossingW \\
HttpAddRequestHeadersA & InternetReadFileExA          \\
HttpAddRequestHeadersW & InternetReadFileExW          \\
HttpSendRequestExA     &                             
\end{longtable}

\textbf{Removed hooks}

\begin{longtable}{*{2}{>{\arraybackslash}p{6cm}}}
NtReadFile            & NtDeviceIoControlFile   \\
NtQueryDirectoryFile  & NtQueryInformationFile  \\
NtOpenDirectoryObject & FindFirstFileExA        \\
FindFirstFileExW      & GetDiskFreeSpaceExA     \\
GetDiskFreeSpaceExW   & GetDiskFreeSpaceA       \\
GetDiskFreeSpaceW     & RegEnumKeyW             \\
RegEnumKeyExA         & RegEnumKeyExW           \\
RegEnumValueA         & RegEnumValueW           \\
RegQueryValueExA      & RegQueryValueExW        \\
RegQueryInfoKeyA      & RegQueryInfoKeyW        \\
NtEnumerateKey        & NtEnumerateValueKey     \\
NtQueryValueKey       & NtQueryMultipleValueKey \\
NtLoadKey             & NtLoadKey2              \\
NtLoadKeyEx           & NtQueryKey              \\
FindWindowA           & FindWindowW             \\
FindWindowExA         & FindWindowExW           \\
EnumWindows           & NtOpenMutant            \\
NtOpenSection         & ZwMapViewOfSection      \\
ExitProcess           & NtUnmapViewOfSection    \\
NtFreeVirtualMemory   & SetWindowsHookExA       \\
SetWindowsHookExW     & UnhookWindowsHookEx     \\
LdrGetDllHandle       & LdrGetProcedureAddress  \\
ExitWindowsEx         & LookupPrivilegeValueW   \\
WriteConsoleA         & WriteConsoleW           \\
GetSystemMetrics      & GetCursorPos            \\
GetComputerNameA      & GetComputerNameW        \\
GetUserNameA          & GetUserNameW            \\
NtDelayExecution      & GetLocalTime            \\
GetSystemTime         & GetTickCount            \\
NtQuerySystemTime     & send                    \\
sendto                & recv                    \\
recvfrom              & select                  \\
connect               & WSARecv                 \\
WSARecvFrom           & WSASend                 \\
WSASendTo             & CryptProtectData        \\
CryptUnprotectData    & CryptProtectMemory      \\
CryptUnprotectMemory  & CryptDecrypt            \\
CryptEncrypt          & CryptHashData           \\
CryptDecodeMessage    & CryptDecryptMessage     \\
CryptEncryptMessage   & CryptHashMessage       
\end{longtable}

\end{document}
